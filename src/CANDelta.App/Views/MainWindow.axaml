<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:CANDelta.App.ViewModels"
        xmlns:controls="using:CANDelta.App.Controls"
        x:Class="CANDelta.App.Views.MainWindow"
        x:DataType="vm:MainWindowViewModel"
        Title="{Binding Title}"
        Width="1200" Height="700"
        WindowStartupLocation="CenterScreen">

    <Grid RowDefinitions="Auto,Auto,*,Auto">
        <!-- Toolbar Row 1: Connection & Capture -->
        <Border Grid.Row="0" Background="{DynamicResource SystemControlBackgroundChromeMediumBrush}" Padding="8">
            <StackPanel Orientation="Horizontal" Spacing="8">
                <!-- Connection -->
                <ComboBox ItemsSource="{Binding AvailablePorts}"
                          SelectedItem="{Binding SelectedPort}"
                          Width="120"
                          IsEnabled="{Binding !IsConnected}"/>
                <Button Command="{Binding RefreshPortsCommand}"
                        Content="Refresh"
                        IsEnabled="{Binding !IsConnected}"/>
                <Button Command="{Binding ConnectCommand}">
                    <TextBlock Text="{Binding IsConnected, Converter={x:Static vm:MainWindowViewModel.ConnectButtonConverter}}"/>
                </Button>

                <Separator/>

                <!-- Speed -->
                <TextBlock Text="Speed:" VerticalAlignment="Center"/>
                <ComboBox ItemsSource="{Binding AvailableSpeeds}"
                          SelectedItem="{Binding SelectedSpeed}"
                          Width="100"
                          IsEnabled="{Binding !IsCapturing}">
                    <ComboBox.ItemTemplate>
                        <DataTemplate>
                            <TextBlock Text="{Binding Converter={x:Static vm:MainWindowViewModel.SpeedDisplayConverter}}"/>
                        </DataTemplate>
                    </ComboBox.ItemTemplate>
                </ComboBox>

                <Separator/>

                <!-- Capture -->
                <Button Command="{Binding ToggleCaptureCommand}"
                        IsEnabled="{Binding IsConnected}">
                    <StackPanel Orientation="Horizontal" Spacing="4">
                        <Ellipse Width="10" Height="10"
                                 Fill="{Binding IsCapturing, Converter={x:Static vm:MainWindowViewModel.CaptureLedConverter}}"/>
                        <TextBlock Text="{Binding IsCapturing, Converter={x:Static vm:MainWindowViewModel.CaptureButtonConverter}}"/>
                    </StackPanel>
                </Button>
            </StackPanel>
        </Border>

        <!-- Toolbar Row 2: Theme & Clear -->
        <Border Grid.Row="1" Background="{DynamicResource SystemControlBackgroundChromeMediumBrush}"
                Padding="8,4" BorderThickness="0,1,0,0" BorderBrush="{DynamicResource SystemControlForegroundBaseMediumBrush}">
            <StackPanel Orientation="Horizontal" Spacing="8">
                <TextBlock Text="Theme:" VerticalAlignment="Center"/>
                <ComboBox ItemsSource="{Binding AvailableThemes}"
                          SelectedItem="{Binding SelectedTheme}"
                          Width="100">
                    <ComboBox.ItemTemplate>
                        <DataTemplate x:DataType="vm:ColorTheme">
                            <StackPanel Orientation="Horizontal" Spacing="6">
                                <Rectangle Width="12" Height="12"
                                           Fill="{Binding AlertColor, Converter={x:Static vm:MainWindowViewModel.ColorToBrushConverter}}"
                                           RadiusX="2" RadiusY="2"/>
                                <TextBlock Text="{Binding Name}"/>
                            </StackPanel>
                        </DataTemplate>
                    </ComboBox.ItemTemplate>
                </ComboBox>

                <Separator/>

                <Button Command="{Binding ClearMonitorCommand}"
                        Content="Clear"/>
            </StackPanel>
        </Border>

        <!-- Main Content: CAN Monitor -->
        <Border Grid.Row="2" Margin="8">
            <Grid RowDefinitions="Auto,*">
                <!-- Header -->
                <Border Grid.Row="0" Background="{DynamicResource SystemControlBackgroundChromeMediumLowBrush}"
                        Padding="8,4" CornerRadius="4,4,0,0">
                    <StackPanel Orientation="Horizontal" Spacing="0">
                        <TextBlock Width="56" Text="CAN ID" FontWeight="SemiBold" FontFamily="Consolas,Menlo,monospace"/>
                        <!-- Byte values -->
                        <TextBlock Width="36" Text="B0" FontWeight="SemiBold" TextAlignment="Center" FontFamily="Consolas,Menlo,monospace"/>
                        <TextBlock Width="36" Text="B1" FontWeight="SemiBold" TextAlignment="Center" FontFamily="Consolas,Menlo,monospace"/>
                        <TextBlock Width="36" Text="B2" FontWeight="SemiBold" TextAlignment="Center" FontFamily="Consolas,Menlo,monospace"/>
                        <TextBlock Width="36" Text="B3" FontWeight="SemiBold" TextAlignment="Center" FontFamily="Consolas,Menlo,monospace"/>
                        <TextBlock Width="36" Text="B4" FontWeight="SemiBold" TextAlignment="Center" FontFamily="Consolas,Menlo,monospace"/>
                        <TextBlock Width="36" Text="B5" FontWeight="SemiBold" TextAlignment="Center" FontFamily="Consolas,Menlo,monospace"/>
                        <TextBlock Width="36" Text="B6" FontWeight="SemiBold" TextAlignment="Center" FontFamily="Consolas,Menlo,monospace"/>
                        <TextBlock Width="36" Text="B7" FontWeight="SemiBold" TextAlignment="Center" FontFamily="Consolas,Menlo,monospace"/>
                        <!-- Sparkline graphs -->
                        <Border Width="16"/>
                        <TextBlock Width="50" Text="G0" FontWeight="SemiBold" TextAlignment="Center" FontFamily="Consolas,Menlo,monospace" Foreground="#666666"/>
                        <TextBlock Width="50" Text="G1" FontWeight="SemiBold" TextAlignment="Center" FontFamily="Consolas,Menlo,monospace" Foreground="#666666"/>
                        <TextBlock Width="50" Text="G2" FontWeight="SemiBold" TextAlignment="Center" FontFamily="Consolas,Menlo,monospace" Foreground="#666666"/>
                        <TextBlock Width="50" Text="G3" FontWeight="SemiBold" TextAlignment="Center" FontFamily="Consolas,Menlo,monospace" Foreground="#666666"/>
                        <TextBlock Width="50" Text="G4" FontWeight="SemiBold" TextAlignment="Center" FontFamily="Consolas,Menlo,monospace" Foreground="#666666"/>
                        <TextBlock Width="50" Text="G5" FontWeight="SemiBold" TextAlignment="Center" FontFamily="Consolas,Menlo,monospace" Foreground="#666666"/>
                        <TextBlock Width="50" Text="G6" FontWeight="SemiBold" TextAlignment="Center" FontFamily="Consolas,Menlo,monospace" Foreground="#666666"/>
                        <TextBlock Width="50" Text="G7" FontWeight="SemiBold" TextAlignment="Center" FontFamily="Consolas,Menlo,monospace" Foreground="#666666"/>
                    </StackPanel>
                </Border>

                <!-- Data Rows -->
                <ScrollViewer Grid.Row="1" HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Auto">
                    <ItemsControl ItemsSource="{Binding MonitoredIds}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <VirtualizingStackPanel/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate x:DataType="vm:MonitoredCanId">
                                <Border Padding="8,2" BorderThickness="0,0,0,1"
                                        BorderBrush="{DynamicResource SystemControlForegroundBaseLowBrush}">
                                    <StackPanel Orientation="Horizontal" Spacing="0">
                                        <!-- CAN ID -->
                                        <TextBlock Width="56"
                                                   Text="{Binding IdDisplay}"
                                                   FontFamily="Consolas,Menlo,monospace"
                                                   VerticalAlignment="Center"/>

                                        <!-- 8 Data Bytes -->
                                        <Border Width="36" Padding="2" Background="{Binding Bytes[0].Background}">
                                            <TextBlock Text="{Binding Bytes[0].DisplayText}"
                                                       Foreground="{Binding Bytes[0].Foreground}"
                                                       FontFamily="Consolas,Menlo,monospace"
                                                       TextAlignment="Center"/>
                                        </Border>
                                        <Border Width="36" Padding="2" Background="{Binding Bytes[1].Background}">
                                            <TextBlock Text="{Binding Bytes[1].DisplayText}"
                                                       Foreground="{Binding Bytes[1].Foreground}"
                                                       FontFamily="Consolas,Menlo,monospace"
                                                       TextAlignment="Center"/>
                                        </Border>
                                        <Border Width="36" Padding="2" Background="{Binding Bytes[2].Background}">
                                            <TextBlock Text="{Binding Bytes[2].DisplayText}"
                                                       Foreground="{Binding Bytes[2].Foreground}"
                                                       FontFamily="Consolas,Menlo,monospace"
                                                       TextAlignment="Center"/>
                                        </Border>
                                        <Border Width="36" Padding="2" Background="{Binding Bytes[3].Background}">
                                            <TextBlock Text="{Binding Bytes[3].DisplayText}"
                                                       Foreground="{Binding Bytes[3].Foreground}"
                                                       FontFamily="Consolas,Menlo,monospace"
                                                       TextAlignment="Center"/>
                                        </Border>
                                        <Border Width="36" Padding="2" Background="{Binding Bytes[4].Background}">
                                            <TextBlock Text="{Binding Bytes[4].DisplayText}"
                                                       Foreground="{Binding Bytes[4].Foreground}"
                                                       FontFamily="Consolas,Menlo,monospace"
                                                       TextAlignment="Center"/>
                                        </Border>
                                        <Border Width="36" Padding="2" Background="{Binding Bytes[5].Background}">
                                            <TextBlock Text="{Binding Bytes[5].DisplayText}"
                                                       Foreground="{Binding Bytes[5].Foreground}"
                                                       FontFamily="Consolas,Menlo,monospace"
                                                       TextAlignment="Center"/>
                                        </Border>
                                        <Border Width="36" Padding="2" Background="{Binding Bytes[6].Background}">
                                            <TextBlock Text="{Binding Bytes[6].DisplayText}"
                                                       Foreground="{Binding Bytes[6].Foreground}"
                                                       FontFamily="Consolas,Menlo,monospace"
                                                       TextAlignment="Center"/>
                                        </Border>
                                        <Border Width="36" Padding="2" Background="{Binding Bytes[7].Background}">
                                            <TextBlock Text="{Binding Bytes[7].DisplayText}"
                                                       Foreground="{Binding Bytes[7].Foreground}"
                                                       FontFamily="Consolas,Menlo,monospace"
                                                       TextAlignment="Center"/>
                                        </Border>

                                        <!-- Spacer -->
                                        <Border Width="16"/>

                                        <!-- 8 Sparkline Graphs -->
                                        <Border Width="50" Height="16" Margin="0,1" BorderThickness="1" BorderBrush="#333333" Background="#1A1A1A">
                                            <controls:Sparkline Points="{Binding Bytes[0].GraphPoints}"
                                                               Stroke="{Binding Bytes[0].Foreground}"
                                                               StrokeThickness="1"/>
                                        </Border>
                                        <Border Width="50" Height="16" Margin="0,1" BorderThickness="1" BorderBrush="#333333" Background="#1A1A1A">
                                            <controls:Sparkline Points="{Binding Bytes[1].GraphPoints}"
                                                               Stroke="{Binding Bytes[1].Foreground}"
                                                               StrokeThickness="1"/>
                                        </Border>
                                        <Border Width="50" Height="16" Margin="0,1" BorderThickness="1" BorderBrush="#333333" Background="#1A1A1A">
                                            <controls:Sparkline Points="{Binding Bytes[2].GraphPoints}"
                                                               Stroke="{Binding Bytes[2].Foreground}"
                                                               StrokeThickness="1"/>
                                        </Border>
                                        <Border Width="50" Height="16" Margin="0,1" BorderThickness="1" BorderBrush="#333333" Background="#1A1A1A">
                                            <controls:Sparkline Points="{Binding Bytes[3].GraphPoints}"
                                                               Stroke="{Binding Bytes[3].Foreground}"
                                                               StrokeThickness="1"/>
                                        </Border>
                                        <Border Width="50" Height="16" Margin="0,1" BorderThickness="1" BorderBrush="#333333" Background="#1A1A1A">
                                            <controls:Sparkline Points="{Binding Bytes[4].GraphPoints}"
                                                               Stroke="{Binding Bytes[4].Foreground}"
                                                               StrokeThickness="1"/>
                                        </Border>
                                        <Border Width="50" Height="16" Margin="0,1" BorderThickness="1" BorderBrush="#333333" Background="#1A1A1A">
                                            <controls:Sparkline Points="{Binding Bytes[5].GraphPoints}"
                                                               Stroke="{Binding Bytes[5].Foreground}"
                                                               StrokeThickness="1"/>
                                        </Border>
                                        <Border Width="50" Height="16" Margin="0,1" BorderThickness="1" BorderBrush="#333333" Background="#1A1A1A">
                                            <controls:Sparkline Points="{Binding Bytes[6].GraphPoints}"
                                                               Stroke="{Binding Bytes[6].Foreground}"
                                                               StrokeThickness="1"/>
                                        </Border>
                                        <Border Width="50" Height="16" Margin="0,1" BorderThickness="1" BorderBrush="#333333" Background="#1A1A1A">
                                            <controls:Sparkline Points="{Binding Bytes[7].GraphPoints}"
                                                               Stroke="{Binding Bytes[7].Foreground}"
                                                               StrokeThickness="1"/>
                                        </Border>
                                    </StackPanel>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>
            </Grid>
        </Border>

        <!-- Status Bar -->
        <Border Grid.Row="3" Background="{DynamicResource SystemControlBackgroundChromeMediumBrush}" Padding="8,4">
            <Grid ColumnDefinitions="*,Auto,Auto,Auto,Auto,Auto,Auto">
                <TextBlock Grid.Column="0" Text="{Binding StatusMessage}"/>
                <Separator Grid.Column="1"/>
                <TextBlock Grid.Column="2" Text="{Binding UniqueIdCount, StringFormat='IDs: {0}'}" Margin="8,0"/>
                <Separator Grid.Column="3"/>
                <TextBlock Grid.Column="4" Text="{Binding FrameCount, StringFormat='Frames: {0}'}" Margin="8,0"/>
                <Separator Grid.Column="5"/>
                <TextBlock Grid.Column="6"
                           Text="{Binding FramesPerSecond, StringFormat={}{0} fps}"
                           Foreground="{Binding FramesPerSecond, Converter={x:Static vm:MainWindowViewModel.FpsColorConverter}}"
                           Margin="8,0"/>
            </Grid>
        </Border>
    </Grid>
</Window>
